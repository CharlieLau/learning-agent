# 第十四章：深度挖掘

**核心主题**：Deep Research 智能体

---

## 📖 Day 14: 数据中心的秘密

**发现现场**：
```bash
$ ./friday --investigate "遗迹数据中心"

Location: 地下 B 区
Assets Found:
- 实验日志: 10,000+ 页
- 破碎数据: TB 级
- 运行终端: 1 台

Mission: 解开岛屿真相

Initial Attempt:
Query: "这里发生过什么？"
Response: "根据日志第302页，那天天气晴朗，有人打翻了咖啡。"

Evaluation: ✗ 失败
Issue: 检索 ≠ 研究
```

**问题诊断**：
```
传统 RAG:
用户提问 → 搜 Top 3 文档 → 总结回答
↓
单次交互，浅尝辄止

Deep Research:
用户给课题 → 拆解子问题 → 搜资料 → 阅读 → 发现新线索
→ 发起新搜索 → 循环 → 写万字长文
↓
多轮迭代，深度综合
```

---

## 🛠️ 技术解析

### Search vs Research

| 维度 | 传统搜索 (RAG) | 深度研究 (Deep Research) |
|------|---------------|------------------------|
| **交互次数** | 单次 | **多轮迭代** |
| **搜索策略** | 静态 Top-K | **动态追问** |
| **综合能力** | 简单总结 | **深度分析** |
| **输出形式** | 简短回答 | **长篇报告** |
| **适用场景** | 事实查询 | **复杂课题** |

### Deep Research 流程

```
┌──────────────────────────────────────────────────┐
│         Deep Research 状态机                    │
├──────────────────────────────────────────────────┤
│                                                  │
│  Start                                           │
│    ↓                                             │
│  [Plan] 规划下一步搜索                           │
│    ↓                                             │
│  [Act] 执行搜索/读取                             │
│    ↓                                             │
│  [Observe] 分析结果，提取线索                    │
│    ↓                                             │
│  [Reflect] 是否有新问题？                        │
│    ↓          ↓                                  │
│  No         Yes ───────────────┐                │
│    ↓                              │                │
│  [Report] 撰写最终报告            │                │
│    ↓                              │                │
│  End                         继续循环              │
│                                                  │
└──────────────────────────────────────────────────┘
```

### 研究能力要求

1. **问题拆解**：将大课题分解为子问题
2. **线索追踪**：从资料中发现新问题
3. **信息综合**：整合多源信息形成结论
4. **报告撰写**：输出结构化长文

---

## 💻 实现方案

### Deep Research Agent

```python
# research/deep_agent.py

from typing import List, Set
from dataclasses import dataclass

@dataclass
class ResearchState:
    """研究状态"""
    topic: str
    questions: List[str]
    findings: List[dict]
    visited_sources: Set[str]
    iteration: int

class DeepResearchAgent:
    """
    深度研究智能体
    """

    def __init__(self, name: str, tools: dict):
        self.name = name
        self.tools = tools
        self.max_iterations = 10

    def execute_research(self, topic: str) -> str:
        """
        执行深度研究
        """
        print(f"🧐 开始深度研究: {topic}")

        # 初始化状态
        state = ResearchState(
            topic=topic,
            questions=[self._initial_question(topic)],
            findings=[],
            visited_sources=set(),
            iteration=0
        )

        # 研究循环
        while state.iteration < self.max_iterations:
            state.iteration += 1

            # 1. Plan: 规划下一步
            next_question = self._plan_next(state)
            if next_question is None:  # 研究完成
                break

            print(f"🔍 [第{state.iteration}轮] {next_question}")

            # 2. Act: 执行搜索/读取
            raw_data = self._search(next_question)

            # 3. Observe: 分析并提取洞察
            insight = self._analyze(next_question, raw_data)
            print(f"📝 洞察: {insight[:100]}...")

            # 4. 更新状态
            state.findings.append({
                "question": next_question,
                "answer": raw_data,
                "insight": insight
            })
            state.visited_sources.add(self._get_source(raw_data))

            # 5. Reflect: 生成新的问题
            new_questions = self._reflect(state)
            state.questions.extend(new_questions)

            if not new_questions:  # 无新问题，研究完成
                break

        # 6. Report: 撰写最终报告
        report = self._write_report(state)
        return report

    def _initial_question(self, topic: str) -> str:
        """生成初始问题"""
        return f"关于'{topic}'的基础信息是什么？"

    def _plan_next(self, state: ResearchState) -> str:
        """规划下一步研究的问题"""
        if not state.questions:
            return None
        return state.questions.pop(0)

    def _search(self, question: str) -> str:
        """执行搜索"""
        # 调用搜索工具或数据库
        return self.tools["search"].query(question)

    def _analyze(self, question: str, data: str) -> str:
        """分析数据，提取洞察"""
        prompt = f"""
问题: {question}
资料: {data}

请分析这份资料对研究课题的贡献。
发现了什么关键信息？
有什么值得进一步挖掘的概念？
"""
        return self.tools["llm"].generate(prompt)

    def _reflect(self, state: ResearchState) -> List[str]:
        """反思，生成新的研究问题"""
        recent = state.findings[-3:] if len(state.findings) >= 3 else state.findings

        prompt = f"""
研究课题: {state.topic}
已有发现: {recent}

基于现有发现，列出 1-3 个值得深入研究的新问题。
如果没有需要进一步研究的，返回空列表。
"""
        response = self.tools["llm"].generate(prompt)

        # 解析出问题列表
        return self._parse_questions(response)

    def _write_report(self, state: ResearchState) -> str:
        """撰写最终报告"""
        prompt = f"""
研究课题: {state.topic}

研究历程:
{state.findings}

请撰写一份详细的研究报告，包括：
1. 执行摘要
2. 研究过程
3. 主要发现
4. 结论与建议
"""
        return self.tools["llm"].generate(prompt)

    def _parse_questions(self, text: str) -> List[str]:
        """解析问题列表"""
        # 简化实现
        lines = text.strip().split('\n')
        questions = []
        for line in lines:
            if line.strip().startswith(('- ', '• ', '1. ', '2. ', '3. ')):
                questions.append(line.strip()[2:])
        return questions

    def _get_source(self, data: str) -> str:
        """获取数据来源"""
        # 简化实现
        return "unknown"
```

### 实战验证

```bash
$ python research.py --topic "岛屿地下设施的真实用途"

🧐 开始深度研究: 岛屿地下设施的真实用途

🔍 [第1轮] 地下设施日志查询...
📝 洞察: 发现"B区生物实验室"记录

🔍 [第2轮] B区实验室事故记录...
📝 洞察: 发现"样本-X9逃逸"事件

🔍 [第3轮] 样本-X9 特征分析...
📝 洞察: 样本具备拟态能力，畏惧高频声波

🔍 [第4轮] 岛屿声波塔状态查询...
📝 洞察: 所有声波塔均已损坏

🔍 [第5轮] 设施管理层级分析...
📝 洞察: 发现最高管理员权限标识

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
《岛屿事故调查最终报告》
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. 执行摘要
   本岛屿原为"AGI安全测试场"，因纳米机器人失控而废弃。

2. 研究过程
   [详细研究历程...]

3. 主要发现
   - 岛屿是封闭测试环境
   - "野兽"实为失控纳米机器人
   - 当前设备拥有最高管理权限

4. 结论与建议
   警告: 管理员权限离线，防御系统将在48小时后清洗。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Iterations: 5
Sources Analyzed: 12
Report Length: 20 pages
```

---

## 技术对比

| 能力 | 传统 RAG | Deep Research |
|------|---------|---------------|
| 简单问答 | ✓ | ✓ |
| 复杂分析 | ✗ | **✓** |
| 多轮推理 | ✗ | **✓** |
| 长文生成 | ✗ | **✓** |
| 计算成本 | 低 | **高** |

---

## 下一步计划

**当前进展**：
- ✓ 多智能体系统（第十三章）
- ✓ Deep Research（本章）

**紧急发现**：
- 防御系统即将启动
- 需要复杂社会交互解锁
- 时间有限（48小时）

**下一步任务**：
- [ ] 第十五章：生成式智能体社会
- [ ] 第十五章：涌现现象
- [ ] 第十五章：赛博小镇

---

## 系统更新

```bash
$ git log --oneline -1

f4b9c5d feat: add deep research agent

CHANGES:
- 新增 DeepResearchAgent 类
- 实现多轮研究循环
- 添加状态机管理
- 完成岛屿真相调查

VERSION: 1.3.0
STATUS: 真相已查明，需要解锁防御系统
```

---

**→ [第十五章：赛博小镇](./第十五章：赛博小镇.md)**
