# 第十三章：全岛探险队

**核心主题**：多智能体协作系统

---

## 📖 Day 13: 组建精英小队

**任务背景**：
```bash
$ ./friday --mission "探索北纬15度，寻找淡水源"

Mission: 探索未知区域
Constraints:
- 遇到河流不要强渡
- 遇到野兽不要硬拼
- 绘制沿途地图

Team Composition:
- Friday-Leader (规划专家)
- Friday-Scout (侦察兵，装备MCP传感器)
- Friday-Scribe (书记员，背负向量数据库)
```

**系统架构**：
```
┌──────────────────────────────────────────────────┐
│         分层控制系统 (Hierarchical Control)      │
├──────────────────────────────────────────────────┤
│                                                  │
│  User (我)                                       │
│    ↓ 模糊指令                                     │
│  Leader (Planner)                                │
│    ↓ 任务分解                                     │
│  ┌──────────┬──────────┬──────────┐            │
│  │ Scout    │ Scribe   │ ...      │            │
│  │ (执行)   │ (记录)   │ (其他)   │            │
│  └──────────┴──────────┴──────────┘            │
│                                                  │
└──────────────────────────────────────────────────┘
```

---

## 🛠️ 技术解析

### 单体 vs 多体

| 维度 | 单 Agent | Multi-Agent |
|------|---------|-------------|
| **并行能力** | 串行 | **并行** |
| **专业化** | 通用型 | **专家型** |
| **容错性** | 单点故障 | **冗余备份** |
| **复杂度** | 低 | **高** |
| **适用场景** | 简单任务 | **复杂系统** |

### 协作模式

**1. 层级式 (Hierarchical)**
```
Leader → 分配任务 → Sub-agents
  ↑                        ↓
  └──── 汇报结果 ────────────┘
```

**2. 平等式 (Flat)**
```
Agent A ←→ Agent B ←→ Agent C
   (协商、投票、共识)
```

**3. 混合式 (Hybrid)** ← 推荐用于荒岛
```
Leader (战略) + Specialist Teams (战术)
```

### 消息总线架构

```python
# 消息流设计
Message = {
    "from": "Scout",
    "to": "Leader",
    "type": "warning",  # info, warning, error
    "content": "前方河流水位暴涨",
    "timestamp": "2024-01-15T10:30:00Z"
}
```

---

## 💻 实现方案

### 多智能体系统实现

```python
# multi_agent/exploration_team.py

from typing import List, Dict
from dataclasses import dataclass

@dataclass
class Message:
    """消息数据类"""
    from_agent: str
    to_agent: str
    msg_type: str
    content: str

class MessageBus:
    """
    消息总线：Agent 之间的通信通道
    """

    def __init__(self):
        self.messages = []
        self.subscribers = {}

    def subscribe(self, agent_name: str, callback):
        """订阅消息"""
        if agent_name not in self.subscribers:
            self.subscribers[agent_name] = []
        self.subscribers[agent_name].append(callback)

    def publish(self, message: Message):
        """发布消息"""
        self.messages.append(message)
        # 通知订阅者
        if message.to_agent in self.subscribers:
            for callback in self.subscribers[message.to_agent]:
                callback(message)

class SpecialistAgent:
    """
    专家 Agent 基类
    """

    def __init__(self, name: str, role: str, tools: list = None):
        self.name = name
        self.role = role
        self.tools = tools or []
        self.message_bus = None

    def connect(self, bus: MessageBus):
        """连接到消息总线"""
        self.message_bus = bus
        bus.subscribe(self.name, self._on_message)

    def _on_message(self, message: Message):
        """处理收到的消息"""
        print(f"[{self.name}] 收到: {message.content}")

    def send(self, to: str, msg_type: str, content: str):
        """发送消息"""
        msg = Message(self.name, to, msg_type, content)
        self.message_bus.publish(msg)

    def execute(self, task: str) -> str:
        """执行任务"""
        # 调用工具或 LLM
        return f"[{self.name}] 任务完成: {task}"

class TeamCoordinator:
    """
    团队协调器（Leader）
    """

    def __init__(self, leader: SpecialistAgent, members: List[SpecialistAgent]):
        self.leader = leader
        self.members = members
        self.message_bus = MessageBus()

        # 连接所有 Agent
        self.leader.connect(self.message_bus)
        for member in self.members:
            member.connect(self.message_bus)

    def execute_mission(self, mission: str) -> Dict:
        """
        执行任务：规划 → 分配 → 执行 → 汇总
        """
        print(f"🌟 任务启动: {mission}")

        # 1. 队长规划
        plan = self.leader.think(f"制定计划: {mission}")
        print(f"📋 队长计划:\n{plan}")

        # 2. 任务分解与执行
        results = {}
        for member in self.members:
            sub_task = self._extract_task(plan, member.role)
            result = member.execute(sub_task)
            results[member.name] = result

        # 3. 汇总报告
        report = self.leader.think(f"汇总结果: {results}")
        return {"plan": plan, "results": results, "report": report}

    def _extract_task(self, plan: str, role: str) -> str:
        """从计划中提取特定角色的任务"""
        # 简化版：实际需要更复杂的解析
        return f"{role} 任务: 根据 {plan} 执行"
```

### 实战案例：探险队

```python
# examples/exploration_mission.py

from hello_agents import Agent, MCPServer, VectorDB
from multi_agent import TeamCoordinator, SpecialistAgent

# 1. 初始化基础设施
map_db = VectorDB("island_map")
drone_tool = MCPServer("drone_interface")

# 2. 创建专家 Agent
leader = SpecialistAgent(
    name="Leader",
    role="规划专家",
    tools=[]  # 队长不动手
)

scout = SpecialistAgent(
    name="Scout",
    role="侦察兵",
    tools=[drone_tool]  # 侦察兵装备无人机
)

scribe = SpecialistAgent(
    name="Scribe",
    role="记录员",
    tools=[map_db]  # 记录员装备数据库
)

# 3. 组建团队
team = TeamCoordinator(
    leader=leader,
    members=[scout, scribe]
)

# 4. 执行任务
result = team.execute_mission(
    "探索北纬15度瀑布区，寻找淡水源"
)

print(f"\n📊 任务报告:\n{result['report']}")
```

### 执行日志

```bash
$ python exploration_mission.py

🌟 任务启动: 探索北纬15度瀑布区，寻找淡水源

📋 队长计划:
1. 穿越灌木丛
2. 渡过黑水河
3. 到达瀑布
4. 采集水样

[Scout] 执行侦察任务...
[Scout] 警告: 黑水河水位暴涨，流速 5m/s

[Scribe] 检索历史数据...
[Scribe] 警告: 第3天在类似水域遭遇鳄鱼

[Leader] 收到警告，重新规划...
[Leader] 变更计划: 寻找上游枯木桥

[Scout] 执行新计划...
[Scribe] 记录: 枯木桥安全，坐标 (15.01, 120.45)

📊 任务报告:
✓ 找到淡水源
✓ 绘制安全路线
✓ 避开所有危险区域

Performance:
- 协作消息: 12 条
- 任务成功率: 100%
- 安全事件: 0
```

---

## 架构优势

| 优势 | 说明 | 价值 |
|------|------|------|
| **并行处理** | 多 Agent 同时工作 | 效率提升 3x |
| **专业分工** | 每个 Agent 擅长一项 | 准确率提升 |
| **容错能力** | 单个失败不影响整体 | 系统鲁棒性 |
| **可扩展** | 随时添加新角色 | 灵活应对变化 |

---

## 下一步计划

**当前进展**：
- ✓ 评估体系（第十二章）
- ✓ 多智能体协作（本章）

**新发现**：
- 发现遗迹数据中心
- 海量破碎数据
- 需要深度研究能力

**下一步任务**：
- [ ] 第十四章：Deep Research
- [ ] 第十四章：多轮迭代研究
- [ ] 第十四章：复杂课题分解

---

## 系统更新

```bash
$ git commit -m "feat: add multi-agent system"

CHANGES:
- 新增 MessageBus 类
- 实现 SpecialistAgent 基类
- 添加 TeamCoordinator
- 完成探险队案例

VERSION: 1.2.0
STATUS: Friday 现在有团队了，但研究能力有限
```

---

**→ [第十四章：深度挖掘](./第十四章：深度挖掘.md)**
