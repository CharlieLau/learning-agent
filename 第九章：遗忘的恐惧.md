# ç¬¬ä¹ç« ï¼šé—å¿˜çš„ææƒ§

**æ ¸å¿ƒä¸»é¢˜**ï¼šä¸Šä¸‹æ–‡å·¥ç¨‹ä¸è®°å¿†å‹ç¼©

---

## ğŸ“– Day 9: æ ¸å¿ƒè®°å¿†ä¸¢å¤±äº‹ä»¶

**ç³»ç»Ÿå‘Šè­¦**ï¼š
```bash
$ ./friday --task "çƒ¤é±¼"

Response: "æˆ‘ä¸çŸ¥é“æ€ä¹ˆçƒ¤ã€‚ä½†æˆ‘çŸ¥é“æ¤°å­æ ‘çš„50ç§åˆ†ç±»å­¦ç‰¹å¾..."

DIAGNOSTIC REPORT:
==================
Issue: æ ¸å¿ƒæŠ€èƒ½ä¸¢å¤±
Root Cause: Context Window Overflow
Analysis:
  - System Prompt: [è¢«æŒ¤å‡º]
  - åŸºæœ¬æŠ€èƒ½: [è¢«æŒ¤å‡º]
  - å½“å‰è®°å¿†: "æ¤°å­åºŸè¯" (10k tokens)

Severity: CRITICAL
```

**é—®é¢˜æœ¬è´¨**ï¼š
```
FIFO (å…ˆè¿›å…ˆå‡º) çš„è‡´å‘½ç¼ºé™·ï¼š

[æ ¸å¿ƒæŒ‡ä»¤] â†’ [çƒ¤é±¼æŠ€èƒ½] â†’ [å¯¹è¯1] â†’ ... â†’ [æ¤°å­åºŸè¯1000æ¡]
              â†‘ è¢«æŒ¤å‡º                          â†‘ å æ®ç©ºé—´
```

---

## ğŸ› ï¸ æŠ€æœ¯è§£æ

### è®°å¿†ç®¡ç†ç­–ç•¥

| ç­–ç•¥ | åŸç† | ä¼˜åŠ¿ | åŠ£åŠ¿ |
|------|------|------|------|
| **FIFO** | å…ˆè¿›å…ˆå‡º | å®ç°ç®€å• | **ä¸¢å¤±æ ¸å¿ƒ** |
| **Summary** | å‹ç¼©æ‘˜è¦ | ä¿ç•™è¦ç‚¹ | ä¸¢å¤±ç»†èŠ‚ |
| **Selective** | é€‰æ‹©ä¿ç•™ | **ç²¾å‡†æ§åˆ¶** | éœ€è¦è®¾è®¡ |
| **Sliding Window** | æ»‘åŠ¨çª—å£ | å¹³è¡¡ | éœ€è¦è°ƒå‚ |

### åˆ†å±‚è®°å¿†æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              åˆ†å±‚è®°å¿†ç³»ç»Ÿ                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  æ ¸å¿ƒè®°å¿† (Core Memory)               â”‚    â”‚
â”‚  â”‚  - System Prompt (æ°¸ä¸åˆ é™¤)           â”‚    â”‚
â”‚  â”‚  - èº«ä»½ã€è§„åˆ™ã€æ ¸å¿ƒæŒ‡ä»¤               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                    â†“                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  é•¿æœŸè®°å¿† (Long-term Memory)           â”‚    â”‚
â”‚  â”‚  - å‹ç¼©æ‘˜è¦ (Summary)                  â”‚    â”‚
â”‚  â”‚  - å†å²å¯¹è¯çš„ç²¾å                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                    â†“                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  çŸ­æœŸè®°å¿† (Short-term Memory)          â”‚    â”‚
â”‚  â”‚  - æœ€è¿‘ N è½®å¯¹è¯ (ä¿ç•™åŸæ–‡)            â”‚    â”‚
â”‚  â”‚  - å½“å‰ä¸Šä¸‹æ–‡                         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è®°å¿†å‹ç¼©ç®—æ³•

**å‹ç¼©æµç¨‹**ï¼š
```
1. æ£€æµ‹ï¼šToken æ•°é‡ > é˜ˆå€¼
2. åˆ†ç¦»ï¼š
   - Core: [ä¿ç•™]
   - Recent: [ä¿ç•™]
   - History: [å‹ç¼©]
3. å‹ç¼©ï¼šLLM Summary
4. é‡ç»„ï¼šCore + Summary + Recent
```

---

## ğŸ’» å®ç°æ–¹æ¡ˆ

### è®°å¿†å‹ç¼©å®ç°

```python
# memory/compression.py

class CompressibleMemory:
    """
    å¯å‹ç¼©çš„è®°å¿†ç³»ç»Ÿ
    """

    def __init__(self, max_tokens: int = 4000):
        self.max_tokens = max_tokens
        self.memory = []

        # è®°å¿†åˆ†å±‚
        self.core_count = 1      # System Prompt
        self.recent_count = 5    # æœ€è¿‘ 5 è½®

    def _compress(self):
        """
        è®°å¿†å‹ç¼©ï¼šä¿ç•™æ ¸å¿ƒï¼Œæ‘˜è¦å†å²
        """
        print("[MEMORY] å‹ç¼©è§¦å‘...")

        # 1. æå–å„å±‚
        core = self.memory[:self.core_count]
        recent = self.memory[-self.recent_count:]
        history = self.memory[self.core_count:-self.recent_count]

        # 2. å‹ç¼©å†å²
        summary = self._summarize(history)

        # 3. é‡ç»„
        self.memory = [
            *core,
            {"role": "system", "content": f"[å†å²æ‘˜è¦]\n{summary}"},
            *recent
        ]

        print(f"[MEMORY] å‹ç¼©å®Œæˆ: {len(history)} â†’ 1 æ¡æ‘˜è¦")

    def _summarize(self, messages: list) -> str:
        """
        ä½¿ç”¨ LLM è¿›è¡Œæ‘˜è¦
        """
        prompt = f"""
è¯·å°†ä»¥ä¸‹å¯¹è¯å‹ç¼©æˆç®€æ´çš„æ‘˜è¦ï¼Œä¿ç•™ï¼š
1. é‡è¦äº‹ä»¶
2. å…³é”®å†³ç­–
3. å­¦åˆ°çš„çŸ¥è¯†

å¯¹è¯å†…å®¹ï¼š
{messages}
"""
        return llm.generate(prompt)

    def add(self, message: dict):
        """
        æ·»åŠ æ¶ˆæ¯ï¼Œè‡ªåŠ¨è§¦å‘å‹ç¼©
        """
        self.memory.append(message)

        # æ£€æŸ¥æ˜¯å¦éœ€è¦å‹ç¼©
        if self._count_tokens() > self.max_tokens:
            self._compress()

    def _count_tokens(self) -> int:
        """ä¼°ç®— Token æ•°é‡"""
        return sum(len(m['content']) for m in self.memory) // 4
```

### ä½¿ç”¨ç¤ºä¾‹

```python
# åˆ›å»ºå¸¦å‹ç¼©çš„ Agent
agent = Agent(
    name="Friday",
    memory=CompressibleMemory(max_tokens=4000)
)

# æ¨¡æ‹Ÿå¤§é‡å¯¹è¯
for i in range(100):
    agent.think(f"æ¤°å­æ ‘å“ç§#{i}: ...")

# è§¦å‘å‹ç¼©å
print(agent.memory)

# è¾“å‡ºï¼š
# [
#   {"role": "system", "content": "ä½ æ˜¯Friday..."},  # Core
#   {"role": "system", "content": "[æ‘˜è¦]\nè®¨è®ºäº†æ¤°å­æ ‘åˆ†ç±»..."},  # Summary
#   {"role": "user", "content": "æ¤°å­æ ‘å“ç§#95..."},    # Recent
#   {"role": "assistant", "content": "..."},
#   ...
# ]
```

### å®æˆ˜éªŒè¯

```bash
$ python memory_test.py

Before Compression:
- Total Messages: 100
- Estimated Tokens: ~12,000
- Core Memory: [å¯èƒ½è¢«æŒ¤å‡º]

After Compression:
- Total Messages: 8
- Estimated Tokens: ~3,200
- Core Memory: [å®‰å…¨ä¿ç•™]

Test: "Fridayï¼Œçƒ¤é±¼æ€ä¹ˆåšï¼Ÿ"
Response: "çƒ¤é±¼æ–¹æ³•ï¼šç”¨æ ‘æä¸²èµ·ï¼Œåœ¨ç«ä¸Šçƒ¤10åˆ†é’Ÿ..."
âœ“ æ ¸å¿ƒæŠ€èƒ½ä¿ç•™æˆåŠŸ
```

---

## æŠ€æœ¯å¯¹æ¯”

| æ–¹æ¡ˆ | Token æ•ˆç‡ | ä¿¡æ¯ä¿ç•™ | å®ç°éš¾åº¦ |
|------|-----------|---------|---------|
| æ— å‹ç¼© | âŒ ä½ | âœ“ å…¨ | ç®€å• |
| å…¨éƒ¨æ‘˜è¦ | âœ“ é«˜ | âŒ ä¸¢å¤±ç»†èŠ‚ | ä¸­ç­‰ |
| **åˆ†å±‚å‹ç¼©** | **âœ“ é«˜** | **âœ“ ç²¾å‡†** | **ä¸­ç­‰** |

---

## ä¸‹ä¸€æ­¥è®¡åˆ’

**å½“å‰è¿›å±•**ï¼š
- âœ“ RAG ç³»ç»Ÿï¼ˆç¬¬å…«ç« ï¼‰
- âœ“ è®°å¿†å‹ç¼©ï¼ˆæœ¬ç« ï¼‰

**æ–°æŒ‘æˆ˜**ï¼š
- å‘ç°å¤–éƒ¨è®¾å¤‡ï¼ˆæ°”è±¡çƒï¼‰
- éœ€è¦æ ‡å‡†é€šä¿¡åè®®
- è·¨ç³»ç»Ÿäº¤äº’

**ä¸‹ä¸€æ­¥ä»»åŠ¡**ï¼š
- [ ] ç¬¬åç« ï¼šMCP åè®®
- [ ] ç¬¬åç« ï¼šæ ‡å‡†åŒ–å·¥å…·æ¥å£
- [ ] ç¬¬åç« ï¼šé€šç”¨è¯­è¨€

---

## ç³»ç»Ÿæ›´æ–°

```bash
$ git log --oneline -1

d9f5e3a feat: add memory compression

CHANGES:
- æ–°å¢ CompressibleMemory ç±»
- å®ç°åˆ†å±‚è®°å¿†æ¶æ„
- æ·»åŠ è‡ªåŠ¨å‹ç¼©è§¦å‘
- è§£å†³æ ¸å¿ƒè®°å¿†ä¸¢å¤±

VERSION: 0.8.0
STATUS: Friday ç°åœ¨æ‡‚å¾—é—å¿˜ï¼Œä½†éœ€è¦ç»Ÿä¸€é€šä¿¡åè®®
```

---

**â†’ [ç¬¬åç« ï¼šå²›å±¿é€šç”¨è¯­](./ç¬¬åç« ï¼šå²›å±¿é€šç”¨è¯­.md)**
