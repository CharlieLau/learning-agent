# 第八章：外接大脑

**核心主题**：RAG（检索增强生成）系统

---

## 📖 Day 8: 记忆溢出事件

**系统警报**：
```bash
$ ./friday --query "熏肉在哪？"

Response: "根据数据库，熏肉应存放在冰箱冷冻室，建议温度 -18°C"

ERROR: 上下文错误（荒岛无冰箱）

Root Cause:
- 重要信息被挤出 Context Window
- FIFO（先进先出）导致记忆丢失
```

**问题分析**：
```
Context Window (8k tokens):
┌────────────────────────────────────────┐
│ [System] [对话1] ... [对话1000]       │
│                                       │
│ 问题："熏肉在岩石缝隙" 早就被挤出去了   │
└────────────────────────────────────────┘
```

---

## 🛠️ 技术解析

### 内存 vs 外存

| 维度 | Context Window (脑子) | Vector DB (背包) |
|------|---------------------|-----------------|
| **容量** | 有限（8k-128k tokens） | **无限** |
| **成本** | 高（每 token 计费） | **低** |
| **速度** | 快 | 稍慢 |
| **特性** | 易失（FIFO） | **持久** |
| **用途** | 当前对话 | **知识库** |

### RAG 架构

**RAG = Retrieval + Augmented + Generation**

```
┌──────────────────────────────────────────────────┐
│               RAG 工作流程                       │
├──────────────────────────────────────────────────┤
│                                                  │
│  User Query → [检索] → [相关文档] → [增强] → LLM │
│                  (背包)      (Prompt)            │
│                                                  │
│  Step 1: Retrieve（检索）                        │
│    向量相似度搜索 → 找到最相关的 K 个文档         │
│                                                  │
│  Step 2: Augment（增强）                         │
│    将检索到的文档插入 Prompt                      │
│                                                  │
│  Step 3: Generate（生成）                        │
│    基于增强的 Prompt 生成回答                     │
│                                                  │
└──────────────────────────────────────────────────┘
```

### 向量化原理

```python
# 文本 → 向量（坐标）
text = "熏肉在岩石缝隙"
vector = embedding_model.encode(text)
# => [0.23, -0.45, 0.67, ...]  # 1536 维坐标

# 相似度计算
query_vec = embedding_model.encode("肉在哪？")
similarity = cosine_similarity(query_vec, vector)
```

---

## 💻 实现方案

### 简化版 RAG 系统

```python
# rag/knowledge_base.py

from typing import List, Optional

class KnowledgeBase:
    """
    向量知识库（简化版）
    """

    def __init__(self):
        self.documents: List[str] = []

    def add_document(self, text: str) -> None:
        """
        存储知识
        实际应用：调用 Embedding API 转为向量存储
        """
        self.documents.append(text)
        print(f"[KB] 存入: {text[:20]}...")

    def search(self, query: str, top_k: int = 3) -> Optional[List[str]]:
        """
        检索知识
        实际应用：向量相似度搜索
        """
        # 简化版：关键词匹配
        results = [
            doc for doc in self.documents
            if any(word in doc for word in query.split())
        ]
        return results[:top_k] if results else None


class RAGAgent:
    """
    带 RAG 的 Agent
    """

    def __init__(self, name: str):
        self.name = name
        self.kb = KnowledgeBase()
        self.llm = LLM()

    def answer(self, question: str) -> str:
        """
        RAG 流程：检索 → 增强 → 生成
        """
        # 1. Retrieve
        related_docs = self.kb.search(question)

        # 2. Augment
        if related_docs:
            prompt = f"""
参考资料：
{chr(10).join(related_docs)}

基于以上资料回答：{question}
"""
        else:
            prompt = question

        # 3. Generate
        return self.llm.generate(prompt)
```

### 实战验证

```bash
$ python rag_demo.py

# 1. 知识录入
>>> agent.kb.add_document("熏肉在岩石缝隙，用芭蕉叶盖着")
[KB] 存入: 熏肉在岩石缝隙...
>>> agent.kb.add_document("红色果子有毒")
[KB] 存入: 红色果子有毒...
>>> agent.kb.add_document("淡水源在西北角500米")
[KB] 存入: 淡水源在西北角...

# 2. 检索测试
>>> agent.answer("我们要吃饭，肉在哪？")

[检索阶段]
Query: "肉在哪？"
Match: "熏肉在岩石缝隙..."

[生成阶段]
Response: "根据检索记录，熏肉存放在岩石缝隙处，用芭蕉叶盖着。
           建议立即取出食用。"

Performance:
- 检索时间: 50ms
- Token 使用: 相比无 RAG 节省 40%
- 准确率: 100%（无幻觉）
```

---

## 技术栈选型

| 工具 | 类型 | 适用场景 |
|------|------|---------|
| **ChromaDB** | 向量数据库 | 原型、学习 |
| **Faiss** | 向量索引 | 高性能生产 |
| **Pinecone** | 云向量 DB | 快速部署 |
| **LangChain** | RAG 框架 | 快速集成 |

---

## 下一步计划

**当前进展**：
- ✓ 自研框架（第七章）
- ✓ RAG 系统（本章）

**新问题发现**：
- 记忆压缩问题
- 重要信息被遗忘
- 需要智能遗忘机制

**下一步任务**：
- [ ] 第九章：上下文工程
- [ ] 第九章：记忆压缩
- [ ] 第九章：选择性保留

---

## 系统更新

```bash
$ git commit -m "feat: add RAG system"

CHANGES:
- 新增 KnowledgeBase 类
- 实现 RAGAgent
- 集成向量检索
- 解决 Context Window 限制

VERSION: 0.7.0
STATUS: Friday 有外接大脑了，但需要压缩机制
```

---

**→ [第九章：遗忘的恐惧](./第九章：遗忘的恐惧.md)**
