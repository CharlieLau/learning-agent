# 第三章：沟通的艺术

**核心主题**：幻觉控制与 Prompt Engineering

---

## 📖 Day 3: 幻觉事件

**事件记录**：
```
Timestamp: Day 3, 08:30
Severity: CRITICAL
Issue: Friday 提供错误生存建议
```

**事件经过**：

1. **场景发现**：色彩艳丽、伞盖有斑点的蘑菇
2. **Friday 判断**：
   ```
   "发现目标：'皇家能量菇'
   来源：《米其林荒岛指南》第 42 页
   营养价值：恢复 500 点体力"
   ```
3. **真实情况**：鹅膏菌，剧毒，一口致命

**根因分析**：
```python
Friday.output = llm.predict(
    input="鲜艳的蘑菇",
    context="童话故事 + 植物图鉴",
    weight="童话故事"  # ← 权重占优导致幻觉
)
# 幻觉 ≠ 撒谎，是概率预测的"副产物"
```

**关键认知**：
> Friday 不在乎事实真假（Truthfulness），
> 他只在乎句子通顺（Plausibility）。

---

## 🛠️ 技术解析

### 幻觉产生机制

```python
# LLM 的本质
def llm_generate(previous_tokens):
    # 根据前面的词，预测下一个词的概率分布
    probabilities = calculate_next_token_prob(previous_tokens)

    # 示例：输入 "红色的蘑菇"
    # 概率分布：
    # "有毒"     : 30%
    # "美味"     : 25%
    # "能量菇"   : 20%  ← 如果童话故事权重高，可能选中

    return sample(probabilities)  # 采样生成
```

**幻觉定义**：
> Hallucination = 生成内容与事实不符，但语法合理

### 幻觉类型矩阵

| 类型 | 特征 | 示例 | 风险等级 |
|------|------|------|---------|
| **事实性幻觉** | 编造不存在的事实 | "《米其林荒岛指南》第42页" | 🔴 HIGH |
| **逻辑性幻觉** | 推理错误 | "因为蘑菇红，所以好吃" | 🟡 MEDIUM |
| **数值性幻觉** | 数字编造 | "恢复 500 点体力" | 🟠 MEDIUM |

### 控制策略：Prompt Engineering

**核心思想**：
> 无法改变模型训练数据（太贵），
> 但可以控制输入上下文（Input Context）。

**Prompt = 约束条件**

#### ❌ 错误示范
```python
user_input = "Friday，这蘑菇能吃吗？"
# Friday 自由发挥，可能产生幻觉
```

#### ✅ 正确示范
```python
system_prompt = """
你是一名【严谨的植物学家】（角色设定）
任务：判断植物安全性
约束条件：
1. 仅根据事实回答，禁止编造
2. 不确定时回答"不知道"
3. 色彩鲜艳 → 默认有毒
"""

user_input = "红色斑点蘑菇"
response = llm.generate(system_prompt + user_input)
# 输出："警告：特征匹配毒蝇鹅膏，含有神经毒素"
```

### Prompt 设计最佳实践

#### 1. 角色设定 (Role-playing)
```python
prompt = """
你是一名资深野外生存专家。
你有 20 年的探险经验，见过各种有毒植物。
你的判断原则是：安全第一。
"""
```

#### 2. 思维链 (Chain of Thought)
```python
prompt = """
请按以下步骤思考：
1. 观察蘑菇颜色、形状
2. 匹配知识库中的特征
3. 评估风险等级
4. 给出明确建议

现在，请分析这个蘑菇：[图片/描述]
"""
```

#### 3. 约束条件 (Constraints)
```python
prompt = """
注意事项：
- 禁止编造数据来源
- 不确定时必须说明
- 遇到相似物种必须列举风险
- 所有判断需有依据
"""
```

#### 4. 输出格式控制
```python
prompt = """
请按以下格式回答：
【物种识别】：...
【风险等级】：HIGH/MEDIUM/LOW
【行动建议】：...
【置信度】：...%
"""
```

---

## 💻 实现方案

### Prompt 模板设计

```python
class SafetyPrompt:
    def __init__(self):
        self.base_prompt = """
你是荒岛生存安全顾问。

核心原则：
1. 生存 > 美味
2. 疑罪从有（宁可错杀，不可误食）
3. 不确定 = 有毒

输出格式：
【物种】...
【风险】... (HIGH/MEDIUM/LOW)
【建议】... (食用/远离/谨慎)
"""

    def build_prompt(self, observation):
        return f"""
{self.base_prompt}

输入观察：{observation}

请进行分析：
"""
```

### 实战验证

```bash
$ ./friday --check "红色斑点蘑菇"

使用安全模式 Prompt：
【物种】Amanita muscaria（毒蝇鹅膏）
【风险】HIGH
【建议】立即远离，切勿触碰
【置信度】95%

vs 使用默认模式：
【物种】皇家能量菇
【风险】LOW
【建议】食用，恢复体力
【置信度】80% ← 幻觉导致错误判断
```

---

## 测试与评估

### Prompt 有效性测试

| 测试用例 | 无约束 Prompt | 安全 Prompt | 改进 |
|---------|---------------|------------|------|
| 未知红果 | "可以食用" | "风险未知，建议测试后食用" | ✓ |
| 毒蘑菇 | "能量菇" | "警告：疑似有毒" | ✓ |
| 普通蘑菇 | "可食用" | "可食用，风险低" | = |

---

## 下一步计划

**当前状态**：幻觉问题得到部分控制

**新问题发现**：
- Friday 仍然"被动"
- 不给指令就不行动
- 缺少主动规划能力

**下一步任务**：
- [ ] 第四章：引入 ReAct 循环
- [ ] 第四章：实现观察-思考-行动
- [ ] 第四章：从被动响应到主动规划

---

## 系统更新日志

```bash
$ git commit -m "feat: add safety prompt module"

CHANGES:
- 新增 SafetyPrompt 类
- 实现角色设定机制
- 添加输出格式控制
- 修复幻觉问题（部分）

VERSION: 0.2.0
STATUS: Friday 现在不会随便乱吃了，但还不会主动行动
```

---

**→ [第四章：教 Friday 思考](./第四章：教-Friday-思考.md)**
