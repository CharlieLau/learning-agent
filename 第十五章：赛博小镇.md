# 第十五章：赛博小镇

**核心主题**：生成式智能体社会与涌现

---

## 📖 Day 15: 虚拟世界的诞生

**系统事件**：
```bash
$ ./cyber_town --init --agents 25

System: 赛博小镇 v1.0
Loading: 25 Generative Agents
Status: ONLINE

[10:00 AM] Alice (面包师) 在公园遇到 Bob (画家)
[10:05 AM] Alice: "我刚烤了牛角包，要尝尝吗？"
[10:10 AM] Bob 告诉了 Charlie (邮递员)
[12:00 PM] 🎉 自发事件: 牛角包品鉴会
```

**涌现现象**：
```
输入: 人设 + 记忆系统
输出: 派对（未预设脚本）

结论: 个体的互动 → 群体的智能（涌现）
```

---

## 🛠️ 技术解析

### 传统 NPC vs 生成式 Agent

| 维度 | 传统 NPC | 生成式 Agent |
|------|---------|-------------|
| **行为** | 固定脚本 | **动态生成** |
| **记忆** | 无状态 | **记忆流** |
| **社交** | 孤立 | **互动产生新行为** |
| **实现** | if-else | **LLM + 状态机** |

### 涌现 (Emergence)

**定义**：复杂系统中，个体交互产生未经设计的群体行为

**示例**：
- 蚂蚁觅食 → 智能路径
- 鸟群飞行 → 复杂阵型
- Agent 社交 → 派对文化

### Stanford Generative Agents 架构

```
┌──────────────────────────────────────────────────┐
│         生成式 Agent 核心组件                    │
├──────────────────────────────────────────────────┤
│                                                  │
│  1. 记忆流 (Memory Stream)                       │
│     - 时间戳事件列表                             │
│     - 无限延长的"日记"                          │
│                                                  │
│  2. 反思 (Reflection)                            │
│     - 定期综合记忆                               │
│     - 生成高层次洞察                             │
│                                                  │
│  3. 规划 (Planning)                              │
│     - 基于反思决定未来行动                       │
│     - 行动队列管理                               │
│                                                  │
│  循环: 感知 → 记忆 → 反思 → 规划 → 行动         │
│                                                  │
└──────────────────────────────────────────────────┘
```

---

## 💻 实现方案

### 生成式 Agent 核心

```python
# generative_agents/base.py

from typing import List, Dict
from datetime import datetime

class MemoryStream:
    """
    记忆流：Agent 的"日记本"
    """

    def __init__(self, retention_seconds: int = 86400):
        self.memories: List[Dict] = []
        self.retention = retention_seconds

    def add(self, event: str, importance: float):
        """添加记忆"""
        self.memories.append({
            "content": event,
            "timestamp": datetime.now(),
            "importance": importance,
            "access_count": 0
        )

    def retrieve(self, query: str, top_k: int = 3) -> List[Dict]:
        """
        检索相关记忆
        基于时间近度 + 重要性 + 相关性
        """
        # 简化版：返回最近的重要记忆
        scored = [
            (m, m["importance"] - (datetime.now() - m["timestamp"]).seconds / 3600)
            for m in self.memories
        ]
        scored.sort(key=lambda x: x[1], reverse=True)
        return [m for m, _ in scored[:top_k]]

class GenerativeAgent:
    """
    生成式智能体
    """

    def __init__(self, name: str, persona: str):
        self.name = name
        self.persona = persona
        self.memory = MemoryStream()

    def observe(self, observation: str, importance: float = 0.5):
        """
        感知环境
        """
        self.memory.add(observation, importance)
        print(f"[{self.name}] 观察: {observation}")

    def reflect(self) -> str:
        """
        反思：从记忆中提取高阶洞察
        """
        # 获取最近记忆
        recent = self.memory.retrieve("recent", top_k=50)

        prompt = f"""
你是 {self.name}，性格是 {self.persona}。

最近经历:
{self._format_memories(recent)}

请基于这些经历进行反思：
1. 你目前关注的核心话题是什么？
2. 你对其他 Agent 有什么印象？
3. 你有什么高层次的洞察？

生成 3 条反思。
"""
        insights = self.llm_generate(prompt)

        # 将洞察也存入记忆，成为长期认知
        self.memory.add(f"[反思] {insights}", importance=1.0)
        return insights

    def plan_next_action(self, nearby_agents: List[str]) -> str:
        """
        规划下一步行动
        """
        # 1. 获取洞察
        insights = self.reflect()

        # 2. 检索相关记忆
        relevant = self.memory.retrieve("social", top_k=5)

        prompt = f"""
我是 {self.name}，性格是 {self.persona}。

我的思考:
{insights}

相关记忆:
{self._format_memories(relevant)}

当前附近的 Agent: {nearby_agents}

请决定:
1. 我想做什么？
2. 我想跟谁说话？
3. 我想说什么/做什么？

输出行动描述。
"""
        action = self.llm_generate(prompt)

        # 3. 记录行动计划
        self.memory.add(f"[计划] {action}", importance=0.8)
        return action

    def llm_generate(self, prompt: str) -> str:
        """调用 LLM 生成"""
        # 实际实现中调用 OpenAI API
        return "生成的回答..."

    def _format_memories(self, memories: List[Dict]) -> str:
        """格式化记忆"""
        return "\n".join([
            f"- {m['content']} (重要度: {m['importance']})"
            for m in memories
        ])
```

### 实战验证

```bash
$ python cyber_town.py

Initializing Cyber Town...
Loading 25 agents...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Simulation Log
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[10:00] Alice 观察: 在公园看到了 Bob
[10:00] Alice 反思: 我最近很无聊，想社交
[10:05] Alice 行动: "嗨 Bob，我烤了牛角包，要尝尝吗？"

[10:05] Bob 观察: Alice 邀请我吃牛角包
[10:05] Bob 反思: Alice 很友善，我喜欢面包
[10:06] Bob 行动: "太好了！我最爱牛角包！"

[10:10] Charlie 观察: Bob 吃了牛角包
[10:10] Charlie 反思: 牛角包是个热门话题
[10:15] Charlie 行动: 告诉其他人...

[12:00] 🎉 涌现事件: 牛角包品鉴会自发组织！
         参与者: Alice, Bob, Charlie, +5 others
         来源: 非脚本，自然产生

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Simulation Statistics:
- Agents: 25
- Interactions: 127
- Emergent Events: 3 (派对, 争论, 组建乐队)
- Time: 4 hours (simulated)
```

---

## 涌现的条件

| 条件 | 说明 | 实现 |
|------|------|------|
| **足够智能的个体** | 能理解环境 | LLM 赋能 |
| **记忆能力** | 能积累经验 | MemoryStream |
| **社交机制** | 能相互影响 | Message Bus |
| **反思能力** | 能产生高阶认知 | Reflection |
| **开放性** | 不限制可能性 | 自由行动 |

---

## 下一步计划

**当前进展**：
- ✓ Deep Research（第十四章）
- ✓ 生成式社会（本章）

**系统状态**：
- 防御系统已解锁
- 发现"多智能体号"方舟
- 需要构建操作系统级应用

**最终任务**：
- [ ] 第十六章：系统集成
- [ ] 第十六章：毕业设计
- [ ] 第十六章：方舟启动

---

## 系统更新

```bash
$ git commit -m "feat: add generative agents society"

CHANGES:
- 新增 GenerativeAgent 类
- 实现 MemoryStream
- 添加反思与规划机制
- 观察到涌现现象

VERSION: 1.4.0
STATUS: 赛博小镇运行中，防御系统已解锁
```

---

**→ [第十六章：最终的方舟](./第十六章：最终的方舟.md)**
